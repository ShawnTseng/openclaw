# ğŸ“± Instagram å¹³å°æ•´åˆè¨ˆåŠƒ

> Buddy ShopAI å¤šå¹³å°æ“´å±•ï¼šInstagram Direct Message æ”¯æ´  
> æœ€å¾Œæ›´æ–°ï¼š2026-02-13

---

## ğŸ¯ ç›®æ¨™

å°‡ Buddy ShopAI å¾å–®ä¸€ LINE å¹³å°æ“´å±•è‡³æ”¯æ´ **Instagram Direct Message (DM)**ï¼Œ  
è®“æœé£¾é›»å•†å®¢æˆ¶å¯ä»¥åœ¨ Instagram ä¸Šä¹Ÿèƒ½æä¾› AI æ™ºæ…§å®¢æœï¼Œæå‡å¤šå¹³å°å®¢æˆ¶é«”é©—ã€‚

---

## ğŸ“Š ç‚ºä»€éº¼è¦æ”¯æ´ Instagramï¼Ÿ

### å¸‚å ´éœ€æ±‚

| è§€å¯Ÿ | æ•¸æ“š/èªªæ˜ |
|------|----------|
| Instagram åœ¨å°ç£æ™®åŠç‡ | è¶…é 900 è¬æ´»èºç”¨æˆ¶ï¼ˆ2025ï¼‰ |
| æœé£¾é›»å•†ä¸»è¦å°æµå¹³å° | Instagram > Facebook > LINEï¼ˆå¹´è¼•æ—ç¾¤ï¼‰ |
| å®¢æˆ¶ä½¿ç”¨ç¿’æ…£ | è¨±å¤šæ¶ˆè²»è€…ç¿’æ…£åœ¨ IG DM è©¢å•å•†å“ç´°ç¯€ |
| ç«¶çˆ­å„ªå‹¢ | ç›®å‰å¸‚é¢ä¸Šå°‘æœ‰åŒæ™‚æ”¯æ´ LINE + IG çš„ AI å®¢æœ |

### å®¢æˆ¶ç—›é»

- **åˆ†æ•£å¼å®¢æœç®¡ç†**ï¼šLINE èˆ‡ IG åˆ†åˆ¥å›è¦†ï¼Œæ•ˆç‡ä½
- **IG DM å›è¦†æ…¢**ï¼šæ™šä¸Šæˆ–å‡æ—¥æ²’äººå€¼ç­
- **FAQ é‡è¤‡å›ç­”**ï¼šåœ¨ IG ä¸Šä¹Ÿè¦ä¸€ç›´å›ç­”é‹è²»ã€é€€è²¨ç­‰å•é¡Œ

---

## ğŸ—ï¸ æŠ€è¡“æ¶æ§‹è¨­è¨ˆ

### æ–¹æ¡ˆæ¯”è¼ƒ

| æ–¹æ¡ˆ | å„ªé» | ç¼ºé» | å»ºè­° |
|------|------|------|------|
| **Meta Graph API** | å®˜æ–¹æ­£å¼ APIã€ç©©å®šå¯é  | éœ€ç”³è«‹ Meta Businessã€å¯©æ ¸åš´æ ¼ | âœ… æ¨è–¦ï¼ˆæ­£å¼ç’°å¢ƒï¼‰ |
| **Instagram Basic Display API** | ç°¡å–®æ˜“ç”¨ | ç„¡æ³•å›è¦†è¨Šæ¯ï¼ˆåƒ…è®€å–ï¼‰ | âŒ ä¸é©ç”¨ |
| **ç¬¬ä¸‰æ–¹æœå‹™ï¼ˆå¦‚ Chatfuelï¼‰** | ç„¡éœ€é–‹ç™¼ | æˆæœ¬é«˜ã€å®¢è£½åŒ–å—é™ | âš ï¸ å‚™é¸ï¼ˆå¿«é€Ÿé©—è­‰ï¼‰ |

### æ¡ç”¨æ–¹æ¡ˆï¼šMeta Graph API

ä½¿ç”¨ **Instagram Messaging API**ï¼ˆMeta Graph API çš„ä¸€éƒ¨åˆ†ï¼‰ä¾†æ¥æ”¶èˆ‡å›è¦† Instagram DMã€‚

---

## ğŸ”§ Instagram Messaging API åŸºç¤

### å‰ç½®éœ€æ±‚

1. **Meta Business å¸³è™Ÿ**  
   - å»ºç«‹ Meta Business å¸³è™Ÿï¼ˆå…è²»ï¼‰
   - é€£çµ Instagram å°ˆæ¥­å¸³è™Ÿï¼ˆCreator / Businessï¼‰

2. **Meta App èˆ‡æ¬Šé™**  
   - åœ¨ Meta for Developers å»ºç«‹ App
   - ç”³è«‹ `instagram_manage_messages` æ¬Šé™ï¼ˆéœ€å¯©æ ¸ï¼‰

3. **Webhook è¨‚é–±**  
   - è¨­å®š Webhook URL æ¥æ”¶è¨Šæ¯äº‹ä»¶
   - é©—è­‰ Webhookï¼ˆMeta æœƒç™¼é€ GET è«‹æ±‚é©—è­‰ï¼‰

### API æµç¨‹å°æ¯”ï¼šLINE vs Instagram

| æ­¥é©Ÿ | LINE Messaging API | Instagram Messaging API |
|------|-------------------|------------------------|
| **æ¥æ”¶è¨Šæ¯** | Webhook POST `/api/linewebhook` | Webhook POST `/api/igwebhook` |
| **è¨Šæ¯æ ¼å¼** | `events[].message.text` | `entry[].messaging[].message.text` |
| **å›è¦†è¨Šæ¯** | `POST https://api.line.me/v2/bot/message/reply` | `POST https://graph.facebook.com/v18.0/me/messages` |
| **é©—è­‰ç°½ç« ** | HMAC-SHA256ï¼ˆLINE Channel Secretï¼‰ | SHA1ï¼ˆMeta App Secretï¼‰ |
| **èªè­‰æ–¹å¼** | Channel Access Tokenï¼ˆHeaderï¼‰ | Page Access Tokenï¼ˆQuery Paramï¼‰ |

---

## ğŸ’» å¯¦ä½œè¨ˆåŠƒ

### Phase 1ï¼šInstagram Webhook æ¥æ”¶ï¼ˆ1-2 é€±ï¼‰

#### 1.1 å»ºç«‹æ–°çš„ Azure Functionï¼š`IGWebhook.cs`

```csharp
[Function("IGWebhook")]
public async Task<HttpResponseData> Run(
    [HttpTrigger(AuthorizationLevel.Function, "get", "post")] HttpRequestData req)
{
    // GET: Webhook é©—è­‰ï¼ˆMeta åˆæ¬¡è¨­å®šæ™‚æœƒå‘¼å«ï¼‰
    if (req.Method == "GET")
    {
        return VerifyWebhook(req);
    }
    
    // POST: æ¥æ”¶è¨Šæ¯
    var payload = await JsonSerializer.DeserializeAsync<IGWebhookPayload>(req.Body);
    
    // è™•ç†è¨Šæ¯ï¼ˆèˆ‡ LINE å…±ç”¨æ ¸å¿ƒé‚è¼¯ï¼‰
    await ProcessMessageAsync(payload);
    
    return req.CreateResponse(HttpStatusCode.OK);
}
```

#### 1.2 è¨­è¨ˆçµ±ä¸€çš„è¨Šæ¯æŠ½è±¡å±¤

```csharp
public interface IMessagePlatform
{
    Task<string> GetUserMessageAsync(object payload);
    Task SendReplyAsync(string userId, string message);
    bool ValidateSignature(string signature, string body);
}

public class LineMessagePlatform : IMessagePlatform { ... }
public class InstagramMessagePlatform : IMessagePlatform { ... }
```

#### 1.3 æ›´æ–° `LineWebhook.cs` ä½¿ç”¨æŠ½è±¡å±¤

å°‡ç¾æœ‰çš„ LINE è™•ç†é‚è¼¯é‡æ§‹ç‚ºå…±ç”¨æœå‹™ï¼Œé¿å…é‡è¤‡ç¨‹å¼ç¢¼ã€‚

---

### Phase 2ï¼šInstagram ç°½ç« é©—è­‰èˆ‡å›è¦†ï¼ˆ1 é€±ï¼‰

#### 2.1 ç°½ç« é©—è­‰ï¼ˆSHA1ï¼‰

Instagram ä½¿ç”¨ä¸åŒçš„ç°½ç« æ¼”ç®—æ³•ï¼ˆSHA1 vs LINE çš„ HMAC-SHA256ï¼‰ï¼š

```csharp
public bool ValidateIGSignature(string signature, string body, string appSecret)
{
    var hash = SHA1.HashData(Encoding.UTF8.GetBytes(body + appSecret));
    var computedSignature = "sha1=" + BitConverter.ToString(hash).Replace("-", "").ToLower();
    return signature == computedSignature;
}
```

#### 2.2 ç™¼é€å›è¦†è¨Šæ¯

```csharp
public async Task SendIGReply(string recipientId, string message)
{
    var url = $"https://graph.facebook.com/v18.0/me/messages?access_token={_pageAccessToken}";
    var payload = new
    {
        recipient = new { id = recipientId },
        message = new { text = message }
    };
    
    await _httpClient.PostAsJsonAsync(url, payload);
}
```

---

### Phase 3ï¼šå¤šç§Ÿæˆ¶ Config æ“´å±•ï¼ˆ3-5 å¤©ï¼‰

#### 3.1 Config æ–°å¢ Instagram è¨­å®š

```json
{
  "storeName": "é…·æ½®é¸è²¨åº—",
  "platforms": {
    "line": {
      "enabled": true,
      "channelId": "...",
      "webhookUrl": "https://coolshop-func.azurewebsites.net/api/linewebhook"
    },
    "instagram": {
      "enabled": true,
      "pageId": "...",
      "webhookUrl": "https://coolshop-func.azurewebsites.net/api/igwebhook"
    }
  },
  "faq": [ ... ]
}
```

#### 3.2 Key Vault æ–°å¢ Instagram Secrets

```bash
az keyvault secret set --vault-name kv{tenant}prod \
  --name Instagram-PageAccessToken --value "YOUR_PAGE_TOKEN"

az keyvault secret set --vault-name kv{tenant}prod \
  --name Instagram-AppSecret --value "YOUR_APP_SECRET"
```

---

### Phase 4ï¼šå°è©±æ­·å²çµ±ä¸€ç®¡ç†ï¼ˆ3-5 å¤©ï¼‰

#### 4.1 Table Storage Schema æ“´å±•

ç¾æœ‰çš„ `ConversationMessageEntity` å·²ç¶“å¾ˆé€šç”¨ï¼Œåªéœ€æ–°å¢ `Platform` æ¬„ä½ï¼š

```csharp
public class ConversationMessageEntity : ITableEntity
{
    public string PartitionKey { get; set; }  // userId
    public string RowKey { get; set; }        // timestamp
    public string Platform { get; set; }      // "LINE" or "Instagram"
    public string Role { get; set; }          // "user" or "assistant"
    public string Content { get; set; }
    public DateTimeOffset? Timestamp { get; set; }
    public ETag ETag { get; set; }
}
```

#### 4.2 è·¨å¹³å°å°è©±éš”é›¢

åŒä¸€ç”¨æˆ¶åœ¨ LINE èˆ‡ IG çš„å°è©±æ‡‰è©²åˆ†é–‹å„²å­˜ï¼š

```csharp
var partitionKey = $"{platform}_{userId}";  // ä¾‹å¦‚ï¼š"Instagram_1234567890"
```

---

## ğŸš€ éƒ¨ç½²èˆ‡ä¸Šç·šæµç¨‹

### 1. Meta Business è¨­å®š

#### 1.1 å»ºç«‹ Meta App

1. å‰å¾€ [Meta for Developers](https://developers.facebook.com/)
2. å»ºç«‹æ–° App â†’ é¸æ“‡ã€ŒBusinessã€é¡å‹
3. æ–°å¢ç”¢å“ â†’ é¸æ“‡ã€ŒMessengerã€èˆ‡ã€ŒInstagramã€
4. å–å¾— App ID èˆ‡ App Secret

#### 1.2 é€£çµ Instagram å¸³è™Ÿ

1. åœ¨ App è¨­å®šä¸­ï¼Œå‰å¾€ã€ŒInstagramã€â†’ã€ŒåŸºæœ¬è¨­å®šã€
2. é€£çµ Instagram å°ˆæ¥­å¸³è™Ÿï¼ˆå¿…é ˆæ˜¯ Business / Creator å¸³è™Ÿï¼‰
3. ç”¢ç”Ÿ Page Access Tokenï¼ˆæ°¸ä¹…æˆ–é•·æœŸ Tokenï¼‰

#### 1.3 è¨­å®š Webhook

```
Callback URL: https://{tenant}-func.azurewebsites.net/api/igwebhook
Verify Token: è‡ªè¨‚ä¸€å€‹éš¨æ©Ÿå­—ä¸²ï¼ˆç”¨æ–¼åˆæ¬¡é©—è­‰ï¼‰

è¨‚é–±æ¬„ä½ï¼š
âœ… messages
âœ… messaging_postbacks
âœ… messaging_optins
```

#### 1.4 æäº¤æ‡‰ç”¨ç¨‹å¼å¯©æ ¸

Meta è¦æ±‚ `instagram_manage_messages` æ¬Šé™éœ€è¦å¯©æ ¸ï¼š

- æä¾› App ä½¿ç”¨èªªæ˜èˆ‡å½±ç‰‡ Demo
- èªªæ˜å•†æ¥­ç”¨é€”ï¼ˆAI å®¢æœï¼‰
- å¯©æ ¸æ™‚é–“ï¼šé€šå¸¸ 3-7 å€‹å·¥ä½œå¤©

---

### 2. Azure éƒ¨ç½²

```bash
# éƒ¨ç½²åŒ…å« IG Webhook çš„æ–°ç‰ˆæœ¬
./scripts/deploy-app.sh {tenant}

# ä¸Šå‚³ Instagram Secrets
az keyvault secret set --vault-name kv{tenant}prod{random} \
  --name Instagram-PageAccessToken --value "YOUR_PAGE_TOKEN"

az keyvault secret set --vault-name kv{tenant}prod{random} \
  --name Instagram-AppSecret --value "YOUR_APP_SECRET"
```

---

### 3. æ¸¬è©¦é©—è­‰

#### 3.1 Webhook é©—è­‰

Meta æœƒç™¼é€ GET è«‹æ±‚é©—è­‰ Webhookï¼š

```
GET /api/igwebhook?hub.mode=subscribe&hub.challenge=123456&hub.verify_token=YOUR_TOKEN
```

Function éœ€æ­£ç¢ºå›å‚³ `hub.challenge` åƒæ•¸ã€‚

#### 3.2 è¨Šæ¯æ¸¬è©¦

1. åœ¨ Instagram App ä¸­å‚³è¨Šæ¯çµ¦å“ç‰Œå¸³è™Ÿ
2. æª¢æŸ¥ Application Insights æ˜¯å¦æ”¶åˆ° Webhook äº‹ä»¶
3. ç¢ºèª AI å›è¦†æ­£å¸¸é¡¯ç¤ºåœ¨ IG DM

---

## âš ï¸ æ³¨æ„äº‹é …èˆ‡é™åˆ¶

### Meta API é™åˆ¶

| é™åˆ¶é …ç›® | èªªæ˜ |
|---------|------|
| **è¨Šæ¯çª—å£ï¼ˆ24 å°æ™‚è¦å‰‡ï¼‰** | åªèƒ½åœ¨ç”¨æˆ¶ä¸»å‹•å‚³è¨Šå¾Œ 24 å°æ™‚å…§å›è¦†ï¼ˆé™¤éä½¿ç”¨ Message Tagsï¼‰ |
| **é€Ÿç‡é™åˆ¶** | æ¯å€‹ Page æ¯åˆ†é˜æœ€å¤š 200 æ¬¡ API å‘¼å« |
| **å¯©æ ¸è¦æ±‚** | `instagram_manage_messages` æ¬Šé™éœ€è¦é€šé Meta å¯©æ ¸ |
| **å¸³è™Ÿé¡å‹** | å¿…é ˆæ˜¯ Instagram å°ˆæ¥­å¸³è™Ÿï¼ˆBusiness / Creatorï¼‰ |

### Message Tagsï¼ˆå»¶é•·å›è¦†çª—å£ï¼‰

å¦‚æœéœ€è¦åœ¨ 24 å°æ™‚å¾Œä»èƒ½å›è¦†ï¼Œå¯ä½¿ç”¨ Message Tagsï¼š

```json
{
  "recipient": { "id": "USER_ID" },
  "message": { "text": "..." },
  "messaging_type": "MESSAGE_TAG",
  "tag": "CONFIRMED_EVENT_UPDATE"  // ç”¨æ–¼è¨‚å–®æ›´æ–°ç­‰
}
```

---

## ğŸ“ˆ æœªä¾†å„ªåŒ–æ–¹å‘

### çŸ­æœŸï¼ˆ3 å€‹æœˆå…§ï¼‰

- [ ] **Instagram å¿«é€Ÿå›è¦†ï¼ˆQuick Repliesï¼‰**  
  æä¾›é è¨­é¸é …æŒ‰éˆ•ï¼Œæå‡äº’å‹•é«”é©—ã€‚

- [ ] **Instagram Story Mentions**  
  ç›£è½ç”¨æˆ¶åœ¨ Story ä¸­ tag å“ç‰Œï¼Œè‡ªå‹•å›è¦†ã€‚

### ä¸­æœŸï¼ˆ6 å€‹æœˆå…§ï¼‰

- [ ] **Facebook Messenger æ”¯æ´**  
  åŒæ¨£ä½¿ç”¨ Meta Graph APIï¼ŒæŠ€è¡“æ¶æ§‹ç›¸ä¼¼ã€‚

- [ ] **çµ±ä¸€å¤šå¹³å°å¾Œå°**  
  æä¾› Web Portalï¼Œåº—å®¶å¯åœ¨å–®ä¸€ä»‹é¢ç®¡ç† LINEã€IGã€FB è¨Šæ¯ã€‚

### é•·æœŸï¼ˆ12 å€‹æœˆå…§ï¼‰

- [ ] **WhatsApp Business API**  
  é€²è»æµ·å¤–å¸‚å ´å¿…å‚™ï¼ˆæ±å—äºã€æ­ç¾ï¼‰ã€‚

- [ ] **å…¨é€šè·¯å®¢æœæ•´åˆ**  
  æ•´åˆé›»å•†å¹³å°è¨Šæ¯ä¸­å¿ƒï¼ˆShoplineã€91APPï¼‰ã€‚

---

## ğŸ“ å­¸ç¿’è³‡æº

### å®˜æ–¹æ–‡ä»¶

- [Meta for Developers - Instagram Platform](https://developers.facebook.com/docs/instagram)
- [Instagram Messaging API Overview](https://developers.facebook.com/docs/messenger-platform/instagram)
- [Messenger Platform Webhooks](https://developers.facebook.com/docs/messenger-platform/webhooks)

### æ•™å­¸å½±ç‰‡

- [Meta for Developers - Getting Started](https://developers.facebook.com/docs/development/register)
- [Instagram Graph API Tutorial](https://www.youtube.com/results?search_query=instagram+graph+api+tutorial)

### ç¯„ä¾‹ç¨‹å¼ç¢¼

- [Meta SDK for .NET](https://github.com/facebook-csharp-sdk/facebook-csharp-sdk)
- [Instagram Webhook Sample (Node.js)](https://github.com/fbsamples/messenger-platform-samples)

---

## ğŸ’¡ å¿«é€Ÿé–‹å§‹ï¼š5 æ­¥é©Ÿé©—è­‰å¯è¡Œæ€§

æƒ³å¿«é€Ÿæ¸¬è©¦ Instagram æ•´åˆï¼Ÿè·Ÿè‘—é€™å€‹ç°¡åŒ–æµç¨‹ï¼š

### Step 1ï¼šç”³è«‹ Meta Business å¸³è™Ÿï¼ˆ10 åˆ†é˜ï¼‰

å‰å¾€ [Meta Business Suite](https://business.facebook.com/) è¨»å†Šã€‚

### Step 2ï¼šå»ºç«‹æ¸¬è©¦ Appï¼ˆ5 åˆ†é˜ï¼‰

åœ¨ [Meta for Developers](https://developers.facebook.com/) å»ºç«‹ Appã€‚

### Step 3ï¼šé€£çµ Instagramï¼ˆ5 åˆ†é˜ï¼‰

åœ¨ App è¨­å®šä¸­é€£çµä½ çš„ Instagram å¸³è™Ÿã€‚

### Step 4ï¼šæœ¬åœ°æ¸¬è©¦ Webhookï¼ˆ20 åˆ†é˜ï¼‰

```bash
# å•Ÿå‹•æœ¬åœ° Function
func start

# ä½¿ç”¨ ngrok å»ºç«‹å…¬é–‹ URL
ngrok http 7071

# åœ¨ Meta App è¨­å®š Webhook URLï¼ˆngrok æä¾›çš„ HTTPS URLï¼‰
```

### Step 5ï¼šå‚³è¨Šæ¯æ¸¬è©¦ï¼ˆ5 åˆ†é˜ï¼‰

åœ¨ Instagram å‚³è¨Šæ¯çµ¦å“ç‰Œå¸³è™Ÿï¼Œæª¢æŸ¥æ˜¯å¦æ”¶åˆ° Webhook äº‹ä»¶ã€‚

---

**Buddy ShopAI â€” ä½ çš„å…¨é€šè·¯é›»å•†æ™ºæ…§å¥½å¤¥ä¼´** ğŸ¤–âœ¨
