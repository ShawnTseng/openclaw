# ğŸ—ï¸ ç³»çµ±æ¶æ§‹ç¸½è¦½

> Buddy ShopAI æŠ€è¡“æ¶æ§‹è¨­è¨ˆèˆ‡åŸç†

---

## æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LINE Platform                        â”‚
â”‚              (Webhook POST Request)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTPS
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Azure Functions (Compute Layer)              â”‚
â”‚         .NET 8 Isolated Worker, Consumption Plan        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚LineWebhook.csâ”‚â”€â”€â–ºâ”‚Services/     â”‚â”€â”€â–ºâ”‚Models/     â”‚  â”‚
â”‚  â”‚(Entry Point) â”‚   â”‚- History     â”‚   â”‚- Entities  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚- Signature   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â”‚- Prompt      â”‚                    â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚        â”‚        â”‚        â”‚
     â”‚        â”‚        â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â–¼        â–¼        â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Azure   â”‚ â”‚Table â”‚ â”‚   Key Vault   â”‚ â”‚Application   â”‚
â”‚ OpenAI  â”‚ â”‚Storageâ”‚ â”‚  (Secrets)    â”‚ â”‚  Insights    â”‚
â”‚gpt-4o-  â”‚ â”‚(Conv.)â”‚ â”‚+ Managed ID   â”‚ â”‚ (Monitoring) â”‚
â”‚  mini   â”‚ â”‚       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¤šç§Ÿæˆ¶æ¶æ§‹ï¼ˆCell-basedï¼‰

æ¯å€‹å®¢æˆ¶æ“æœ‰**å®Œå…¨ç¨ç«‹**çš„ Azure Resource Groupï¼š

```
Tenant: mrvshop                    Tenant: guban
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ rg-mrvshop-prod      â”‚          â”‚ rg-guban-prod        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ mrvshop-func         â”‚          â”‚ guban-func           â”‚
â”‚ mrvshopt2icu7wp      â”‚          â”‚ guban{random}        â”‚
â”‚ kvmrvshopprodt2i     â”‚          â”‚ kvgubanprod{random}  â”‚
â”‚ mrvshop-openai-prod  â”‚          â”‚ guban-openai-prod    â”‚
â”‚ mrvshop-func (AI)    â”‚          â”‚ guban-func (AI)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å„ªé»

- âœ… **é¢¨éšªéš”é›¢** - ä¸€å€‹ç§Ÿæˆ¶æ•…éšœä¸å½±éŸ¿å…¶ä»–
- âœ… **å¸³å‹™æ¸…æ™°** - æ¯å€‹ RG ç¨ç«‹å¸³å–®
- âœ… **å®¢è£½å½ˆæ€§** - å¯é‡å°ç‰¹å®šå®¢æˆ¶èª¿æ•´
- âœ… **åˆè¦æ€§** - è³‡æ–™å®Œå…¨éš”é›¢

> å¤šç§Ÿæˆ¶æ¶æ§‹æ¡ç”¨ Cell-based æ¨¡å¼ï¼Œæ¯å€‹ç§Ÿæˆ¶çš„è³‡æºå®Œå…¨éš”é›¢ï¼Œå¯ç¨ç«‹ç®¡ç†èˆ‡æ“´å±•ã€‚

---

## æ ¸å¿ƒå…ƒä»¶

### 1. Azure Functionsï¼ˆé‹ç®—å±¤ï¼‰

| å±¬æ€§ | å€¼ |
|------|---|
| Runtime | .NET 8 (Isolated Worker) |
| Plan | Consumption (å‹•æ…‹æ“´å±•) |
| OS | Linux |
| è§¸ç™¼å™¨ | HTTP Trigger |
| èªè­‰ | Function Level |

**é¸æ“‡ç†ç”±**:
- Serverlessï¼Œé›¶å›ºå®šæˆæœ¬
- è‡ªå‹•æ“´å±•ï¼Œæ‡‰å°æµé‡æ³¢å‹•
- èˆ‡ Azure ç”Ÿæ…‹æ•´åˆå®Œç¾

### 2. Azure OpenAIï¼ˆAI å¼•æ“ï¼‰

| å±¬æ€§ | å€¼ |
|------|---|
| æ¨¡å‹ | gpt-4o-mini |
| SKU | Standard |
| TPM | 30,000 |
| å€åŸŸ | East US |

**é¸æ“‡ç†ç”±**:
- æ¯” GPT-3.5 æ›´è°æ˜ä¸”æ›´ä¾¿å®œ
- 128K Context Window
- ä¼æ¥­ç´š SLA

> é¸ç”¨ gpt-4o-mini åœ¨æ€§èƒ½èˆ‡æˆæœ¬é–“å–å¾—æœ€ä½³å¹³è¡¡ï¼Œ128K Context Window æ”¯æ´é•·å°è©±ã€‚

### 3. Azure Table Storageï¼ˆè³‡æ–™å±¤ï¼‰

| ç”¨é€” | Schema |
|------|--------|
| å°è©±æ­·å² | PartitionKey=userId, RowKey=timestamp |
| æ¯ç”¨æˆ¶ä¸Šé™ | 10 å‰‡è¨Šæ¯ï¼ˆ5 è¼ªå°è©±ï¼‰ |
| éæœŸç­–ç•¥ | 24 å°æ™‚ç„¡æ´»å‹•è‡ªå‹•æ¸…é™¤ |

**é¸æ“‡ç†ç”±**:
- æˆæœ¬æ¥µä½ï¼ˆ$0.045/GB/æœˆï¼‰
- æŒä¹…åŒ–ï¼Œè·¨ instance å…±äº«
- ç°¡å–®å¯é 

### 4. Azure Key Vaultï¼ˆå®‰å…¨å±¤ï¼‰

| å„²å­˜é …ç›® | é¡å‹ |
|---------|------|
| LINE Channel Access Token | Secret |
| LINE Channel Secret | Secret |
| Azure OpenAI API Key | Secret |

**å­˜å–æ–¹å¼**: Managed Identity + RBAC

è©³ç´°èªªæ˜ï¼š[å®‰å…¨æ¶æ§‹](SECURITY.md)

---

## è¨Šæ¯è™•ç†æµç¨‹

```
1. Webhook Ingestion
   â””â”€â–º é©—è­‰ HMAC-SHA256 ç°½ç« 

2. Rate Limiting
   â””â”€â–º æª¢æŸ¥ç”¨æˆ¶é€Ÿç‡é™åˆ¶ï¼ˆ10 å•/æ™‚ï¼‰

3. Message Debounce
   â””â”€â–º 3 ç§’å…§é€£çºŒè¨Šæ¯åˆä½µ

4. Context Loading
   â”œâ”€â–º å¾ Table Storage è®€å–å°è©±æ­·å²
   â””â”€â–º å¾ configs/{tenant}.json è®€å–çŸ¥è­˜åº«

5. AI Inference
   â””â”€â–º å‘¼å« Azure OpenAI (gpt-4o-mini)
       â”œâ”€â–º åŒ…å«é‡è©¦æ©Ÿåˆ¶ï¼ˆExponential Backoffï¼‰
       â””â”€â–º è™•ç† 429 Rate Limit

6. Response Delivery
   â””â”€â–º é€é LINE Messaging API å›è¦†

7. State Persistence
   â”œâ”€â–º å¯«å…¥å°è©±åˆ° Table Storage
   â””â”€â–º ç•°æ­¥æ¸…ç†è¶…éä¸Šé™çš„èˆŠè¨Šæ¯
```

---

## æˆæœ¬çµæ§‹ï¼ˆæ¯ç§Ÿæˆ¶ï¼‰

| æœå‹™ | æœˆæˆæœ¬ | èªªæ˜ |
|------|--------|------|
| Azure OpenAI | ~$2-3 | 200å®¢/å¤©Ã—5å•Ã—30å¤© |
| Functions | $0 | å…è²»é¡åº¦ (1M æ¬¡/æœˆ) |
| Storage | ~$0.01 | Table + Blob |
| Key Vault | ~$0.03 | 3 Secrets |
| App Insights | $0 | å…è²» 5GB/æœˆ |
| **ç¸½è¨ˆ** | **~$2.50 USD** | **~78 TWD/æœˆ** |

è©³ç´°åˆ†æï¼š[æˆæœ¬å„ªåŒ–](../guides/COST_OPTIMIZATION.md)

---

## æŠ€è¡“æ±ºç­–

| æ±ºç­– | é¸é … A | é¸é … B | é¸æ“‡ | ç†ç”± |
|------|--------|--------|------|------|
| AI å¼•æ“ | Azure OpenAI | Google Gemini | A | ä¼æ¥­ç´šã€å¯æ§æˆæœ¬ |
| å°è©±å„²å­˜ | IMemoryCache | Table Storage | B | æŒä¹…åŒ–ã€è·¨ instance |
| å¯†é‘°ç®¡ç† | App Settings | Key Vault | B | é›¶æ˜æ–‡é¢¨éšª |
| è¨ˆç®—è³‡æº | Dedicated Plan | Consumption | B | é›¶å›ºå®šæˆæœ¬ |
| å¤šç§Ÿæˆ¶ç­–ç•¥ | Shared RG | Isolated RG | B | é¢¨éšªéš”é›¢ã€å¸³å‹™æ¸…æ™° |

è©³ç´°è¨˜éŒ„ï¼š[ç¶“é©—æ•™è¨“](../development/LESSONS_LEARNED.md)

---

## æ“´å±•æ€§è¨­è¨ˆ

### æ°´å¹³æ“´å±•
- Azure Functions è‡ªå‹•æ“´å±•ï¼ˆConsumption Planï¼‰
- å–®ä¸€ instance å¯è™•ç†å¤šå€‹ä¸¦ç™¼è«‹æ±‚
- Table Storage è‡ªå‹•åˆ†å€ï¼ˆPartitionKey = userIdï¼‰

### å‚ç›´æ“´å±•
- å¯å‡ç´šè‡³ Premium Planï¼ˆå›ºå®šè³‡æºï¼‰
- å¯èª¿æ•´ OpenAI TPM é…é¡

### å€åŸŸæ“´å±•
- æ”¯æ´å¤šå€åŸŸéƒ¨ç½²ï¼ˆç›®å‰ East USï¼‰
- æœªä¾†å¯è€ƒæ…® Southeast Asia é™ä½å»¶é²

---

## ç›£æ§èˆ‡å¯è§€æ¸¬æ€§

- **æ—¥èªŒ**: Application Insights (Traces, Exceptions)
- **æŒ‡æ¨™**: Requests, Duration, Dependencies
- **å‘Šè­¦**: å¯è¨­å®šæˆæœ¬ã€éŒ¯èª¤ç‡å‘Šè­¦ï¼ˆå¾…å¯¦ä½œï¼‰
- **æŸ¥è©¢**: KQL (Kusto Query Language)

è©³ç´°èªªæ˜ï¼š[ç›£æ§èˆ‡ç¶­é‹](../guides/MONITORING.md)

---

## ä¸‹ä¸€æ­¥

- ï¿½ [å®‰å…¨æ¶æ§‹](SECURITY.md)
- ğŸ“Š [æˆæœ¬å„ªåŒ–ç­–ç•¥](../guides/COST_OPTIMIZATION.md)
- âš™ï¸ [é…ç½®ç®¡ç†](../guides/CONFIGURATION.md)
- ğŸ“‹ [éƒ¨ç½²æŒ‡å—](../deployment/DEPLOYMENT_GUIDE.md)

---

**æ¶æ§‹è² è²¬äºº**: Shawn Tseng  
**æœ€å¾Œæ›´æ–°**: 2026-02-13
